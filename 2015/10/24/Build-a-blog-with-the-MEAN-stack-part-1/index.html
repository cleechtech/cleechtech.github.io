<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<!-- Use Build a blog with the MEAN stack (part 1) for dynamic title -->
	<title>El Blogo de Connor</title>

	<!-- Twitter bootstrap (via cdn) -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

	<!-- assets located in source folder -->
	<link rel="stylesheet" href="/css/main.css">

</head>

<div class='row text-center'>
	<form action="//github.us5.list-manage.com/subscribe/post?u=0713e0ac2a414eae4ca4bb786&amp;id=0bdf2bdb00" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="navbar-form" target="_blank" novalidate>
	    <div class="form-group">
	    	<label for="mce-EMAIL">Get notified when I post a new tutorial!</label>
		    <input type="email" value="" name="EMAIL" class="form-control" placeholder="Email address" required>
		    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
		    <div style="position: absolute; left: -5000px;" aria-hidden="true">
		    	<input type="text" name="b_0713e0ac2a414eae4ca4bb786_0bdf2bdb00" tabindex="-1" value="">
		    </div> 	
	    </div>
	    <input type="submit" value="Submit" name="subscribe" class="btn btn-warning">
	</form>
</div>
<body id='wrapper'>
	<div class='hideOverflow'>
		<div class='container blog-post'>
	<div class='row'>
		<div class='col-sm-12'>
			<a href='/' class="btn btn-yellow btn-circle" style='color:grey;'>
            	<i class="fa fa-home fa-2"></i>
        	</a>
		</div>
	</div>
	<div class='row'>
		<h1 class='author-name'>Build a blog with the MEAN stack (part 1)</h1>
	    2015-10-24 
	    <hr />
		<p>I’m posting a blog post on how to make a blog. So meta.</p>
<p><img src="http://media.giphy.com/media/roLxlT1nPN8GI/giphy.gif" alt=""></p>
<p>Check out the <a href="https://github.com/cleechtech/mean-blog" target="_blank" rel="external">SOURCE CODE</a></p>
<a id="more"></a>
<h4 id="Get_crackin">Get crackin</h4><p>Install the starter template and change the names, delete the silly image in the README.</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="keyword">clone</span> <span class="title">git</span>@github.com:jasonshark/mean-starter.git</span><br><span class="line">$ mv mean-starter mean-blog &amp;&amp; cd mean-blog</span><br><span class="line">$ npm install</span><br><span class="line">$ <span class="keyword">node</span><span class="identifier"> </span><span class="title">server</span></span><br></pre></td></tr></table></figure>
<p><em>Tip:</em> install nodemon <code>$ npm install nodemon -g</code> and you won’t have to refresh the page all the time</p>
<h4 id="Render_admin_login">Render admin login</h4><p>There are lots of ways to handle authentication within the meanstack. We’re going to use <a href="http://passportjs.org/" target="_blank" rel="external">Passport.js</a>, the express server and ejs templates. The angular will come in handy once the template is already rendered.</p>
<p>First define our basic routes for the login and register pages. These go in <strong>server/routes.js</strong>.</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="keyword">use</span>(<span class="string">'/api'</span>, apiRouter);	<span class="comment">// haven't built any api yet</span></span><br><span class="line">	app.<span class="keyword">use</span>(<span class="string">'/'</span>, router);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// home route</span></span><br><span class="line">	router.<span class="keyword">get</span>(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> </span>&#123;</span><br><span class="line">		res.render(<span class="string">'index'</span>);</span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// admin route</span></span><br><span class="line">	router.<span class="keyword">get</span>(<span class="string">'/admin'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> </span>&#123;</span><br><span class="line">		res.render(<span class="string">'admin/login'</span>);</span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">	router.<span class="keyword">get</span>(<span class="string">'/admin/register'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> </span>&#123;</span><br><span class="line">		res.render(<span class="string">'admin/register'</span>);</span><br><span class="line">	&#125;);</span><br></pre></td></tr></table></figure>
<p>Now let’s set up the views. We are going to add the ejs template engine and store the views in a new folder called views. First we’ll configure the server to render ejs templates. Add this to the <strong>server.js</strong> express config block:</p>
<p><code>app.set(&#39;view engine&#39;, &#39;ejs&#39;);</code></p>
<p>And add ejs as a dependency for the server:</p>
<p><code>$ npm install ejs --save</code></p>
<p>Next create the views folder and files:<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir views</span><br><span class="line">$ mv public/index<span class="class">.html</span> views/index<span class="class">.ejs</span></span><br><span class="line">$ mkdir views/admin</span><br><span class="line">$ touch views/<span class="number">404</span><span class="class">.ejs</span> views/admin/login<span class="class">.ejs</span> views/admin/register<span class="class">.ejs</span> views/admin/dashboard.ejs</span><br></pre></td></tr></table></figure></p>
<p>In the <strong>views/admin/login.ejs</strong> we will render a basic login form. This will load a full html page with a new <code>&lt;head&gt;</code> and <code>&lt;body&gt;</code>. The body of the template looks like this:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;<span class="tag">div</span> class=<span class="string">'container'</span>&gt;</span><br><span class="line">    &lt;<span class="tag">div</span> class=<span class="string">'row'</span>&gt;</span><br><span class="line">		&lt;<span class="tag">div</span> class=<span class="string">'col-sm-4 col-sm-offset-4 text-center'</span>&gt;</span><br><span class="line">			&lt;h1&gt;Admin Login&lt;/h1&gt;</span><br><span class="line">			&lt;<span class="tag">form</span> method=<span class="string">'post'</span> action=<span class="string">'/login'</span>&gt;</span><br><span class="line">				&lt;<span class="tag">input</span> type=<span class="string">'text'</span> placeholder=<span class="string">'Email'</span> name=<span class="string">'email'</span> ng-model=<span class="string">'user.email'</span> class=<span class="string">'form-control'</span>&gt;</span><br><span class="line"></span><br><span class="line">				&lt;<span class="tag">input</span> type=<span class="string">'password'</span> placeholder=<span class="string">'Password'</span> name=<span class="string">'password'</span> ng-model=<span class="string">'user.password'</span> class=<span class="string">'form-control'</span>&gt;</span><br><span class="line">				&lt;<span class="tag">input</span> type=<span class="string">'submit'</span> class=<span class="string">'btn btn-primary'</span> value=<span class="string">'Login'</span>&gt;</span><br><span class="line">			&lt;/form&gt;</span><br><span class="line">			&lt;<span class="tag">a</span> href=<span class="string">'/admin/register'</span>&gt;Register <span class="tag">a</span> new account&lt;/a&gt;</span><br><span class="line">		&lt;/div&gt;</span><br><span class="line">	&lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br></pre></td></tr></table></figure>
<p>Make sure to include bootstrap CSS and you’re golden. The register form looks like this:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;<span class="tag">div</span> class=<span class="string">'container'</span>&gt;</span><br><span class="line">    &lt;<span class="tag">div</span> class=<span class="string">'row'</span>&gt;</span><br><span class="line">      &lt;<span class="tag">div</span> class=<span class="string">'col-sm-4 col-sm-offset-4 text-center'</span>&gt;</span><br><span class="line">        &lt;h1&gt;New user registration&lt;/h1&gt;</span><br><span class="line">        &lt;<span class="tag">form</span> &lt;<span class="tag">form</span> method=<span class="string">'post'</span> action=<span class="string">'/register'</span>&gt;</span><br><span class="line">          &lt;<span class="tag">input</span> type=<span class="string">'text'</span> placeholder=<span class="string">'Email'</span> name=<span class="string">'email'</span> ng-model=<span class="string">'user.email'</span> class=<span class="string">'form-control'</span>&gt;</span><br><span class="line"></span><br><span class="line">          &lt;<span class="tag">input</span> type=<span class="string">'password'</span> placeholder=<span class="string">'Password'</span> name=<span class="string">'password'</span> ng-model=<span class="string">'user.password'</span> class=<span class="string">'form-control'</span>&gt;</span><br><span class="line">          &lt;<span class="tag">input</span> type=<span class="string">'submit'</span> class=<span class="string">'btn btn-primary'</span> value=<span class="string">'Register'</span>&gt;</span><br><span class="line">        &lt;/form&gt;</span><br><span class="line">        &lt;<span class="tag">a</span> href=<span class="string">'/admin'</span>&gt;Login with an existing account&lt;/a&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br></pre></td></tr></table></figure>
<p>Almost exactly the same. You can now check out the basic forms by navigating to <code>/admin</code> and <code>/admin/register</code>. The next step will be creating users and logging them in</p>
<h4 id="Create_user_model_and_set_up_passport">Create user model and set up passport</h4><p>So in order to have admins we’re going to create a user model in our database. Create the model in <strong>server/models/user.js</strong>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>),</span><br><span class="line">    passportLocalMongoose = <span class="built_in">require</span>(<span class="string">'passport-local-mongoose'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> User = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">	email: &#123;</span><br><span class="line">		type: <span class="built_in">String</span>, </span><br><span class="line">		required: <span class="string">'&#123;PATH&#125; is required!'</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Passport-Local-Mongoose will add a username, </span></span><br><span class="line"><span class="comment">// hash and salt field to store the username, </span></span><br><span class="line"><span class="comment">// the hashed password and the salt value</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// configure to use email for username field</span></span><br><span class="line">User.plugin(passportLocalMongoose, &#123; usernameField: <span class="string">'email'</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = mongoose.model(<span class="string">'User'</span>, User);</span><br></pre></td></tr></table></figure>
<p>To make user management with passport.js simple we’re using <a href="https://github.com/saintedlama/passport-local-mongoose" target="_blank" rel="external">passport-local-mongoose</a>, which is a layer of abstraction on top of <a href="https://github.com/jaredhanson/passport-local" target="_blank" rel="external">passport-local</a>. Passport local is an “authentication strategy” on top of passport. You can include multiple strategies for different providers. This confused me for a long time. Scotch.io has a great <a href="https://scotch.io/tutorials/easy-node-authentication-setup-and-local" target="_blank" rel="external">tutorial series</a> on authenticating with multiple strategies in an express app. I also have an <a href="https://github.com/jasonshark/express-auth" target="_blank" rel="external">example app</a> that implements login with email/password, facebook and spotify together as one. For now we’re going to keep moving forward.</p>
<p><img src="http://media.giphy.com/media/1sSWWMNnaZLlm/giphy.gif" alt="keep swimming"></p>
<p>Install the dependencies:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm <span class="operator"><span class="keyword">install</span> passport passport-<span class="keyword">local</span> passport-<span class="keyword">local</span>-mongoose <span class="comment">--save</span></span></span><br></pre></td></tr></table></figure></p>
<p>Initialize passport.js sessions in <strong>server.js</strong>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> passport = <span class="keyword">require</span>(<span class="string">'passport'</span>);</span><br><span class="line"><span class="keyword">require</span>(<span class="string">'./server/passport'</span>)(passport);   <span class="comment">// this file is defined below</span></span><br><span class="line">app.<span class="keyword">use</span>(passport.initialize());</span><br><span class="line">app.<span class="keyword">use</span>(passport.session());</span><br></pre></td></tr></table></figure>
<p>Define the passport configuration options in <strong>server/passport.js</strong>. I got this directly form the passport-local-mongoose <a href="https://github.com/saintedlama/passport-local-mongoose" target="_blank" rel="external">README</a>:</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// requires the model <span class="keyword">with</span> <span class="type">Passport</span>-<span class="type">Local</span> <span class="type">Mongoose</span> plugged <span class="keyword">in</span></span><br><span class="line"><span class="keyword">var</span> <span class="type">User</span> = require('./models/user'),</span><br><span class="line">	<span class="type">LocalStrategy</span> = require('passport-local').<span class="type">Strategy</span>;</span><br><span class="line"></span><br><span class="line">module.exports = function(passport)&#123;</span><br><span class="line">	// use <span class="keyword">static</span> authenticate <span class="keyword">method</span> <span class="keyword">of</span> model <span class="keyword">in</span> <span class="type">LocalStrategy</span></span><br><span class="line">	passport.use(<span class="type">User</span>.createStrategy());</span><br><span class="line"></span><br><span class="line">	// use <span class="keyword">static</span> serialize <span class="keyword">and</span> deserialize <span class="keyword">of</span> model <span class="keyword">for</span> passport session support</span><br><span class="line">	passport.serializeUser(<span class="type">User</span>.serializeUser());</span><br><span class="line">	passport.deserializeUser(<span class="type">User</span>.deserializeUser());</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h6 id="Create_routes_for_handling_user_login/registration">Create routes for handling user login/registration</h6><p>We have our forms that send plain old POST request. Set up some express routes with passport.js magical middleware. Middleware in express are functions that the request passes through when a route is hit. The request hits the route (for example POST to “/login”) and then goes through a series of functions that take the format <code>function(req, res, next){}</code>. If the <code>next()</code> function gets called the request continues down the chain. Passport provides us middleware that follows this <code>req, res, next</code> pattern:</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="keyword">get</span>(<span class="string">'/admin/dashboard'</span>, isAdmin, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span></span>&#123;</span><br><span class="line">		res.render(<span class="string">'admin/dashboard'</span>, &#123;user: req.user&#125;);</span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">	router.post(<span class="string">'/register'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// passport-local-mongoose: Convenience method to register a new user instance with a given password. Checks if username is unique</span></span><br><span class="line">		User.register(<span class="keyword">new</span> User(&#123;</span><br><span class="line">			email: req.body.email</span><br><span class="line">		&#125;), req.body.password, <span class="function"><span class="keyword">function</span><span class="params">(err, user)</span> </span>&#123;</span><br><span class="line">	        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">	            console.error(err);</span><br><span class="line">	            <span class="keyword">return</span>;</span><br><span class="line">	        &#125;</span><br><span class="line"></span><br><span class="line">	        <span class="comment">// log the user in after it is created</span></span><br><span class="line">	        passport.authenticate(<span class="string">'local'</span>)(req, res, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span><br><span class="line">	        	console.log(<span class="string">'authenticated by passport'</span>);</span><br><span class="line">	        	res.redirect(<span class="string">'/admin/dashboard'</span>);</span><br><span class="line">	        &#125;);</span><br><span class="line">	    &#125;);</span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">	router.post(<span class="string">'/login'</span>, passport.authenticate(<span class="string">'local'</span>), <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span></span>&#123;</span><br><span class="line">		res.redirect(<span class="string">'/admin/dashboard'</span>);</span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">	app.<span class="keyword">use</span>(<span class="function"><span class="keyword">function</span><span class="params">(req, res, next)</span></span>&#123;</span><br><span class="line">		res.status(<span class="number">404</span>);</span><br><span class="line"></span><br><span class="line">		res.render(<span class="string">'404'</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;);</span><br></pre></td></tr></table></figure>
<p>Make sure you have the mongoose User model defined:</p>
<p><code>var User = require(&#39;./models/user&#39;)</code></p>
<p>You’ll see that I threw in an <code>isAdmin</code> variable. That is some middleware I defined myself. It is janky but it will make sure that even if someone registers an account they cannot get to the dashboard unless they log in with my email address.</p>
<figure class="highlight monkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isAdmin</span>(</span>req, res, <span class="keyword">next</span>)&#123;</span><br><span class="line">	<span class="keyword">if</span>(req.isAuthenticated() &amp;&amp; req.user.email === <span class="comment">'connorleech@gmail.com')&#123;</span></span><br><span class="line">		console.<span class="built_in">log</span>(<span class="comment">'cool you are an admin, carry on your way');</span></span><br><span class="line">		<span class="keyword">next</span>();</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		console.<span class="built_in">log</span>(<span class="comment">'You are not an admin');</span></span><br><span class="line">		res.redirect(<span class="comment">'/admin');</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>For more complex apps you could add roles to users. You could add roles by issuing commands to records in MongoDB directly. Here’s how to check out the contents of our database (go ahead and <code>/admin/register</code> first, so you have some data to look at!)</p>
<h4 id="Check_in_the_database_that_users_exist">Check in the database that users exist</h4><p>Let’s check out our database. Open up a mongo shell (<code>$ mongod</code> must be running).</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ mongo</span><br><span class="line">&gt; show dbs</span><br><span class="line">ghost-<span class="keyword">clone</span>     <span class="title">0</span>.<span class="number">078</span>GB</span><br><span class="line">test            <span class="number">0.078</span>GB</span><br><span class="line">&gt; use ghost-<span class="keyword">clone</span></span><br><span class="line"><span class="title">switched</span> to db ghost-<span class="keyword">clone</span></span><br><span class="line"><span class="title">&gt; show</span> collections</span><br><span class="line">system.indexes</span><br><span class="line">users</span><br><span class="line">&gt; db.users.find();</span><br></pre></td></tr></table></figure>
<p>This changes into our database and shows the users. The database may be called “mean-starter” if you do not rename the development database in <strong>server/env.js</strong>.</p>
<h4 id="Set_up_the_admin_dashboard">Set up the admin dashboard</h4><p>We’ve created users in the database and logged them in. What we actually want is a protected dashboard where we can create, edit and save our posts.</p>
<p>First we’re going to set up the layout and create a new angular app called <code>ghost-clone.admin</code>. This app will handle everything that goes on from the <strong>dashboard.ejs</strong> template. I’ve set it up a little like how the ghost platform works. We can add more functionality in later tutorials.</p>
<p><img src="http://cdn.meme.am/instances2/500x/700982.jpg" alt=""></p>
<p>I changed the <code>public/</code> directory to distinguish between our admin angular app and the home angular app:</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public</span><br><span class="line">  <span class="string">|- admin</span></span><br><span class="line">     <span class="string">|- js</span></span><br><span class="line">     <span class="string">|- css</span></span><br><span class="line">     <span class="string">|- templates</span></span><br><span class="line">  <span class="string">|- home</span></span><br><span class="line">     <span class="string">|- js</span></span><br><span class="line">     <span class="string">|- css</span></span><br><span class="line">     <span class="string">|- templates</span></span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">Create the angular app in **public/admin/js/app.js**:</span><br></pre></td></tr></table></figure>
<p>var adminApp = angular.module(‘ghost-clone.admin’, [<br>    ‘ui.router’,<br>    ‘btford.markdown’<br>]);</p>
<p>adminApp.config(function($stateProvider, $urlRouterProvider){</p>
<pre><code><span class="variable">$urlRouterProvider</span>.otherwise(<span class="string">'/'</span>);

<span class="variable">$stateProvider</span>
    .state(<span class="string">'allPosts'</span>, {
        url: <span class="string">'/'</span>,
        templateUrl: <span class="string">'/admin/templates/allPosts.html'</span>
    })
    .state(<span class="string">'addPost'</span>, {
        url: <span class="string">'/addPost'</span>,
        templateUrl: <span class="string">'/admin/templates/addPost.html'</span>
    })
</code></pre><p>});<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Next we're going <span class="keyword">to</span> hand off <span class="keyword">the</span> user object passport added <span class="function_start"><span class="keyword">on</span></span> <span class="keyword">the</span> server `req.user` <span class="keyword">to</span> our `user` variable <span class="keyword">and</span> give <span class="keyword">that</span> <span class="keyword">to</span> <span class="keyword">the</span> angular <span class="type">application</span>.</span><br></pre></td></tr></table></figure></p>
<p><script src="/admin/js/app.js"></script><br>  <script type="text/javascript"><br>    var currentUser = <%- JSON.stringify(user); %>;<br>    adminApp.run(function($rootScope){<br>      $rootScope.currentUser = currentUser;<br>    });<br>  </script><br><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">The &#123;% raw %&#125;`&lt;%- -%&gt;`&#123;% endraw %&#125; is how ejs renders variables. We stringify that <span class="operator">and</span> <span class="keyword">then</span> pass <span class="keyword">it</span> <span class="built_in">to</span> our $rootScope.</span><br><span class="line"></span><br><span class="line">![ejs variables <span class="built_in">to</span> angular.js](<span class="keyword">http</span>://cdn.meme.am/instances2/<span class="number">500</span>x/<span class="number">700964.</span>jpg)</span><br><span class="line"></span><br><span class="line">In <span class="operator">the</span> body I link <span class="built_in">to</span> <span class="operator">a</span> navbar template:</span><br><span class="line"></span><br><span class="line">`&lt;<span class="operator">div</span> ng-<span class="built_in">include</span>=<span class="string">'"/admin/templates/nav.html"'</span>&gt;&lt;/<span class="operator">div</span>&gt;`.</span><br><span class="line"></span><br><span class="line">It<span class="string">'s important to note now angular'</span>s <span class="keyword">using</span> client side templates <span class="operator">with</span> ui.router. These are separate <span class="built_in">from</span> <span class="operator">the</span> server-side ejs templates.</span><br><span class="line"></span><br><span class="line">So now <span class="built_in">create</span> <span class="operator">a</span> navbar template <span class="operator">in</span> **public/admin/templates/nav.html**:</span><br></pre></td></tr></table></figure></p>
<!-- Top navigation -->
<p><nav class="navbar navbar-default navbar-fixed-top" ng-controller="NavCtrl"><br>    <div class="container"><br>      <div class="navbar-header"><br>        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"><br>          <span class="sr-only">Toggle navigation</span><br>          <span class="icon-bar"></span><br>          <span class="icon-bar"></span><br>          <span class="icon-bar"></span><br>        </button><br>        <a class="navbar-brand" href="#">Ghost clone</a><br>      </div><br>      <div id="navbar" class="navbar-collapse collapse"><br>        <ul class="nav navbar-nav"><br>          <li ng-class="{ active: isActive('allPosts') }"><a ui-sref="allPosts">All posts</a></li><br>          <li ng-class="{ active: isActive('addPost') }"><a ui-sref="addPost">New Post</a></li><br>        </ul><br>        <ul class="nav navbar-nav navbar-right"><br>          <li><a href="">{{currentUser.email}}</a></li><br>        </ul><br>      </div><!--/.nav-collapse --><br>    </div><br>  </nav><br><!-- /Top navigation --><br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">And also make a `NavCtrl` <span class="keyword">for</span> this navbar <span class="keyword">that</span> will toggle <span class="keyword">the</span> `.active` <span class="type">class</span> based <span class="function_start"><span class="keyword">on</span></span> <span class="keyword">the</span> current $state ui.router <span class="keyword">is</span> <span class="keyword">in</span>:</span><br></pre></td></tr></table></figure></p>
<p>adminApp.controller(‘NavCtrl’, function($scope, $state){<br>    $scope.active = $state;<br>    $scope.isActive = function(viewLocation){<br>        var active = (viewLocation === $state.current.name);<br>        return active;<br>    };<br>})</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Below <span class="operator">the</span> nav.html tag <span class="operator">in</span> **dashboard.ejs** <span class="built_in">include</span> <span class="operator">a</span> <span class="constant">space</span> <span class="built_in">to</span> render our views</span><br><span class="line"></span><br><span class="line">`&lt;<span class="operator">div</span> ui-view class=<span class="string">'full-height'</span> id=<span class="string">'main-content'</span>&gt;&lt;/<span class="operator">div</span>&gt;`</span><br><span class="line"></span><br><span class="line">Add <span class="keyword">then</span> paste some CSS <span class="keyword">into</span> **public/admin/css/main.css**:</span><br></pre></td></tr></table></figure>
<p>html, body, section, .full-height {<br>    height: 100%;<br>}</p>
<p>#pad{<br>    font-family: Menlo,Monaco,Consolas,”Courier New”,monospace;</p>
<pre><code><span class="attribute">border</span>: <span class="string">none;</span>
<span class="attribute">overflow</span>: <span class="string">auto;</span>
<span class="attribute">outline</span>: <span class="string">none;</span>
<span class="attribute">resize</span>: <span class="string">none;</span>

<span class="less"><span class="attribute">-webkit-box-shadow</span>: none;
<span class="attribute">-moz-box-shadow</span>: none;
<span class="attribute">box-shadow</span>: none;</span>
</code></pre><p>}</p>
<p>#markdown {<br>    overflow: auto;<br>    border-left: 1px solid black;<br>}</p>
<p>#main-content {<br>    margin-top:70px;<br>}<br><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="markdown"><span class="header">#### Parsing markdown</span></span><br><span class="line"></span><br><span class="line">We're going to create two more templates to add a post and also show all of our posts. Create two files <span class="strong">**addPost.html**</span> and <span class="strong">**allPosts.html**</span> in <span class="strong">**public/admin/templates**</span>.</span><br><span class="line"></span><br><span class="line">Next add the [<span class="link_label">angular-markdown-directive</span>](<span class="link_url">https://github.com/jasonshark/angular-markdown-directive</span>). Grab the <span class="strong">**markdown.js**</span> file and include it as a <span class="code">`&lt;script&gt;`</span> in <span class="strong">**dashboard.ejs**</span>.</span><br><span class="line"></span><br><span class="line">Also add <span class="code">`ngSanitize`</span> and the [<span class="link_label">showdown.js</span>](<span class="link_url">https://github.com/showdownjs/showdown</span>) library:</span></span><br></pre></td></tr></table></figure></p>
<p><script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.4.2/angular-sanitize.js"></script><br>   <script src="https://cdn.rawgit.com/showdownjs/showdown/1.0.2/dist/showdown.min.js"></script></p>
<p><script src="/admin/js/lib/markdown.js"></script><br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Then create <span class="tag">a</span> template <span class="keyword">for</span> adding <span class="tag">a</span> title and <span class="tag">a</span> <span class="tag">body</span>. On the <span class="attribute">right</span> hand column we<span class="string">'ll view the markdown preview of the post we'</span>re posting:</span><br></pre></td></tr></table></figure></p>
<p><div class="row full-height"><br>    <div class="col-lg-12"><br>      <div class="form-group"><br>      <input type="text" placeholder="Title" name="title" class="form-control"><br>      </div><br>    </div><br>    <div class="col-lg-12 full-height"><br>        <textarea class="col-md-6 full-height" id="pad" ng-model="text" placeholder="Write your blog post here..."></textarea><br>        <div class="col-md-6 full-height" id="markdown"><br>          <div btf-markdown="text"></div><br>        </div><br>    </div><br></div><br>```</p>
<p>Navigate to New Post (<a href="http://localhost:3000/admin/dashboard#/addPost" target="_blank" rel="external">http://localhost:3000/admin/dashboard#/addPost</a>), start typing a <code># title</code> and you’ll see the markdown preview version, thanks to showdown.js and angular.js data binding.</p>
<h4 id="Conclusion_(for_now)">Conclusion <small>(for now)</small></h4><p>We have a database of users, protected admin access, two angular applications and a template for parsing markdown.</p>
<p>In the next post we will Create, Read, Update and Delete posts. If you have questions about this tutorial, feel free to <a href="http://twitter.com/cleechtech" target="_blank" rel="external">hit me up on twitter</a>.</p>
<p><img src="http://media0.giphy.com/media/V0BIjUQRfl8tO/giphy.gif" alt=""></p>
<p>Also check out the <a href="https://github.com/jasonshark/mean-blog" target="_blank" rel="external">SOURCE CODE</a>.</p>

	</div>
</div>
	</div>
</body>
</html>